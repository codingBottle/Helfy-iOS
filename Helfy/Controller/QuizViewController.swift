//
//  QuestionViewController.swift
//  Helfy
//
//  Created by Ïú§ÏÑ±ÏùÄ on 11/22/23.
//

import UIKit

class QuizViewController: UIViewController {
//    lazy var quizView = QuizView(frame: .zero, quizType: self.convertedQuizType ?? .OX)
    var quizView: QuizView!
    // Ï¥ù Î¨∏Ï†úÏàò
    var totalQuiz: Int = 0
    // ÌòÑÏû¨ Î¨∏Ï†ú Î≤àÌò∏
    var currentQuizNumber: Int = 1
    
    var quizType = ""
    var apiHandler: APIHandler = APIHandler()
    lazy var answer: String = ""
    
    var convertedQuizType: QuizType? {
        switch quizType {
        case "MULTIPLE_CHOICE":
            return .MULTIPLE_CHOICE
        case "OX":
            return .OX
        default:
            return nil
        }
    }
    
    var quizModelData: Quiz? {
        didSet {
            print("Hi")
        }
    }
    
    override func viewDidLoad() {
        super.viewDidLoad()
        view.backgroundColor = .white
        
        quizView = QuizView(frame: .zero, quizType: self.convertedQuizType ?? .MULTIPLE_CHOICE)

        // QuizViewÎ•º Î∑∞ Í≥ÑÏ∏µÏóê Ï∂îÍ∞Ä
        self.view.addSubview(quizView)
        
        quizView.didSelectChoice = { [weak self] choice in
            self?.handleChoiceSelection(choice)
        }
        
        // QuizViewÏùò AutoLayout ÏÑ§Ï†ï
        quizView.translatesAutoresizingMaskIntoConstraints = false
        NSLayoutConstraint.activate([
            quizView.topAnchor.constraint(equalTo: view.safeAreaLayoutGuide.topAnchor),
            quizView.bottomAnchor.constraint(equalTo: view.safeAreaLayoutGuide.bottomAnchor),
            quizView.leadingAnchor.constraint(equalTo: view.leadingAnchor),
            quizView.trailingAnchor.constraint(equalTo: view.trailingAnchor)
        ])
        
        setData()
    }
    
    func updateQuestionNumberDisplay(current: Int, total: Int) {
        quizView.quizNumber.text = "\(current) / \(total)"
    }
    
    func handleChoiceSelection(_ choice: String) {
        let answerType: AnswerType = choice == answer ? .correct : .wrong
        showResultModal(answerType: answerType)
    }
    
    func showResultModal(answerType: AnswerType) {
        let vc = CorrectOrWrongViewController(answerType: answerType)
        vc.modalPresentationStyle = .overCurrentContext
        vc.modalTransitionStyle = .crossDissolve
        self.present(vc, animated: true) {
            DispatchQueue.main.asyncAfter(deadline: .now() + 2.0) {
                vc.dismiss(animated: true) {
                    self.loadNextQuestion()
                }
            }
        }
    }

    func loadNextQuestion() {
        if currentQuizNumber < totalQuiz {
            setData()
            currentQuizNumber += 1
        } else {
            self.navigationController?.popViewController(animated: true)
        }
    }
    
    func setData() {
        DispatchQueue.global(qos: .userInteractive).async {
            // API ÌÜµÌï¥ Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞
            self.apiHandler.getQuizData(type: "TODAY") { data in
                // Ï†ïÏùòÌï¥Îëî Î™®Îç∏ Í∞ùÏ≤¥Ïóê Ìï†Îãπ
                self.quizModelData = data
                
                // Îç∞Ïù¥ÌÑ∞Î•º Ï†úÎåÄÎ°ú Ïûò Î∞õÏïÑÏôîÎã§Î©¥
                guard let data = self.quizModelData, !data.isEmpty else {
                    return print("üî•üî•üî•üî•üî•üî•üî•üî•üî•üî•")
                }
                
                // Ï¥ù Î¨∏Ï†ú ÏàòÎ•º Í≥ÑÏÇ∞Ìï©ÎãàÎã§.
                self.totalQuiz = data.count
                
                DispatchQueue.main.async { [self] in
                    self.quizType = data[0].quizType ?? ""
                    print("QuizType: \(self.quizType)") // ÎîîÎ≤ÑÍπÖÏùÑ ÏúÑÌïú Ï∂úÎ†•
                    
                    self.updateQuestionNumberDisplay(current: currentQuizNumber, total: totalQuiz)

                    
                    self.quizView.quizText.text = data[0].question
                    print("Quiz Text: \(self.quizView.quizText.text ?? "")")
                    
                    // ÏÉàÎ°úÏö¥ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
//                    let newChoice = Choices(
//                        choice1: data[0].choices?.choice1,
//                        choice2: data[0].choices?.choice2,
//                        choice3: data[0].choices?.choice3,
//                        choice4: data[0].choices?.choice4
//                    )
                    
                    self.quizView.newChoice = data[0].choices
                    print("newChoice: \(self.quizView.newChoice)")

                    // ÏÉàÎ°úÏö¥ Ïù∏Ïä§ÌÑ¥Ïä§ Ìï†Îãπ
//                    self.quizView.newChoice = newChoice
                    
//                    print("Quiz Choices: \(self.quizView.newChoice)")

                    self.answer = data[0].answer ?? ""
                    self.quizView.updateMultipleChoiceUI(with: data[0].choices)
                    
                    // Ïù¥ÎØ∏ÏßÄ Î°úÎìú
                    if let imageURLString = data[0].image?.imageURL, let url = URL(string: imageURLString) {
                        let task = URLSession.shared.dataTask(with: url) { (data, response, error) in
                            if let error = error {
                                print("Error: \(error)")
                            } else if let data = data {
                                DispatchQueue.main.async {
                                    self.quizView.quizImage.image = UIImage(data: data)
                                    self.quizView.updateImageLayout()  // Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÌõÑ Ïù¥ÎØ∏ÏßÄ Î†àÏù¥ÏïÑÏõÉ ÏóÖÎç∞Ïù¥Ìä∏
                                }
                            }
                        }
                        
                        task.resume()
                    }
                }
            }
        }
    }
}




//class QuestionViewController: UIViewController {
//    var questionView: QuizView!
//    var choiceView: ChoiceView!
//    var currentQuestionIndex = 0
//    
//    override func viewDidLoad() {
//        super.viewDidLoad()
//        view.backgroundColor = .white
//        
//        let text = "ÏßÄÏßÑÏù¥ ÎÇ¨ÏùÑ Îïå, ÌïòÏßÄÎßêÏïÑÏïºÌï† ÌñâÎèôÏúºÎ°ú Ïö¥ÎèôÏû•ÏúºÎ°ú Îõ∞Ïñ¥Í∞ÑÎã§Îäî ÎßûÏùÑÍπåÏöî~ ÌãÄÎ¶¥ÍπåÏöî~? ÌÉúÌíçÏù¥ Ïò§Í≥† ÏûàÏùÑ Îïå Ï∞ΩÎ¨∏Ïóê ÌÖåÏù¥ÌîÑÎ•º ÏóëÏä§Î°ú Î∂ôÏó¨ÏïºÌï†ÍπåÏöî ÏÑ∏Î°úÎÇò Í∞ÄÎ°úÎ°ú Î∂ôÏó¨ÏïºÌï†ÍπåÏöî~?"
//        let imageUrlString = ""
//        let image: UIImage? = UIImage(systemName: "square.and.arrow.up")
//        let data: [String: Any] = ["text": "Sample Question", "choices": ["ÎßûÎã§, ÏóëÏä§", "ÌãÄÎ¶¨Îã§, ÏóëÏä§", "ÎßûÎã§, ÏÑ∏Î°úÎÇò Í∞ÄÎ°ú", "ÌãÄÎ¶¨Îã§, ÏÑ∏Î°úÎÇò Í∞ÄÎ°ú"], "answerIndex": 1, "image": image]
//        let type: QuestionType = .MultipleQuestion
//
//        let data: [String: Any] = ["text": "Sample Question", "answer": true, "image": image]
//
//        let type: QuestionType = .TrueOrFalseQuestion
//
//        addChoiceView(data: data, type: type)
//
//        if let image = UIImage(systemName: "square.and.arrow.up") {
//            addQuestionView(text: text, image: image)
//        } else {
//            // Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ï§ë ÏóêÎü¨Í∞Ä Î∞úÏÉùÌïú Í≤ΩÏö∞
//            print("Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏóêÎü¨")
//        }
//        
//        if let imageUrl = URL(string: imageUrlString) {
//            URLSession.shared.dataTask(with: imageUrl) { (data, response, error) in
//                if let error = error {
//                    print("Error downloading image: \(error)")
//                } else if let data = data {
//                    DispatchQueue.main.async {
//                        self.addQuestionView(text: text, image: UIImage(data: data))
//                    }
//                }
//            }.resume()
//        }
//    }
//    
//    func addChoiceView(data: [String: Any], type: QuestionType) {
//        // Í∞ùÍ¥ÄÏãù
//        if type == .MultipleQuestion {
//            let multipleChoiceView = MultipleChoiceView(question: MultipleChoiceQuestion.dictionaryMultiple(data: data))
//            choiceView = multipleChoiceView
//            choiceView.translatesAutoresizingMaskIntoConstraints = false
//            view.addSubview(choiceView)
//            NSLayoutConstraint.activate([
//                choiceView.bottomAnchor.constraint(equalTo: self.view.safeAreaLayoutGuide.bottomAnchor),
//                choiceView.leadingAnchor.constraint(equalTo: self.view.leadingAnchor),
//                choiceView.trailingAnchor.constraint(equalTo: self.view.trailingAnchor),
//                choiceView.heightAnchor.constraint(equalToConstant: 270)
//            ])
//            choiceView.display()
//            for button in multipleChoiceView.choiceButtons {
//                button.addTarget(self, action: #selector(buttonTapped(_:)), for: .touchUpInside)
//            }
//        } else {
//            // true or false
//            choiceView = TrueOrFalseQuestionView(question: TrueOrFalseQuestion.dictionaryTrueOrFalse(data: data))
//            choiceView.translatesAutoresizingMaskIntoConstraints = false
//            view.addSubview(choiceView)
//            NSLayoutConstraint.activate([
//                choiceView.bottomAnchor.constraint(equalTo: self.view.safeAreaLayoutGuide.bottomAnchor),
//                choiceView.leadingAnchor.constraint(equalTo: self.view.leadingAnchor),
//                choiceView.trailingAnchor.constraint(equalTo: self.view.trailingAnchor),
//                choiceView.heightAnchor.constraint(equalToConstant: 250)
//            ])
//
//            choiceView.display()
//            if let trueOrFalseView = choiceView as? TrueOrFalseQuestionView {
//                trueOrFalseView.trueButton.addTarget(self, action: #selector(buttonTapped(_:)), for: .touchUpInside)
//                trueOrFalseView.falseButton.addTarget(self, action: #selector(buttonTapped(_:)), for: .touchUpInside)
//            }
//        }
//    }
//    
//    func addQuestionView(text: String, image: UIImage?) {
//        questionView = QuizView(text: text, image: nil)
//        questionView.translatesAutoresizingMaskIntoConstraints = false
//        self.view.addSubview(questionView)
//        
//        // QuestionViewÏóê ÎåÄÌïú Ï†úÏïΩ Ï°∞Í±¥ ÏÑ§Ï†ï
//        NSLayoutConstraint.activate([
//            questionView.topAnchor.constraint(equalTo: self.view.topAnchor),
//            questionView.leadingAnchor.constraint(equalTo: self.view.leadingAnchor),
//            questionView.trailingAnchor.constraint(equalTo: self.view.trailingAnchor),
//            questionView.bottomAnchor.constraint(equalTo: choiceView.topAnchor, constant: -10),
//        ])
//    }
//
//    @objc func buttonTapped(_ sender: UIButton) {
//        // ÏÇ¨Ïö©ÏûêÏùò ÏÑ†ÌÉù Ï†ÄÏû•
//        let userChoice = sender.tag // Í∞Å Î≤ÑÌäºÏóê Í≥†Ïú†Ìïú ÌÉúÍ∑∏Î•º Î∂ÄÏó¨ÌïòÏó¨ Íµ¨Î∂Ñ
//
//        // ÎãµÏïà Ï≤¥ÌÅ¨
//        let isCorrect = checkAnswer(userChoice: userChoice)
//
//        // ÎãµÏïàÏóê Îî∞Î•∏ Î≤ÑÌäº ÏÉâÏÉÅ Î≥ÄÍ≤Ω
//        if isCorrect == true {
//            sender.backgroundColor = UIColor.systemGreen
//        } else {
//            sender.backgroundColor = UIColor.red
//        }
//        // Ï†ïÎãµÏù¥ ÎßûÏúºÎ©¥ Îã§Ïùå Î¨∏Ï†ú Î°úÎìú
//        loadNextQuestion()
//    }
//    
//    func checkAnswer(userChoice: Int) -> Bool {
//        // MultipleChoiceQuestion ÌÉÄÏûÖÏùò Í≤ΩÏö∞
//        if let multipleChoiceView = choiceView as? MultipleChoiceView {
//            let correctAnswer = multipleChoiceView.question.answerIndex
//            return userChoice == correctAnswer // Ïó¨Í∏∞Î•º ÏàòÏ†ïÌïòÏòÄÏäµÎãàÎã§.
//        }
//        // TrueOrFalseQuestion ÌÉÄÏûÖÏùò Í≤ΩÏö∞
//        else if let trueOrFalseView = choiceView as? TrueOrFalseQuestionView {
//            let correctAnswer = trueOrFalseView.question.answer
//            return userChoice == (correctAnswer ? 1 : 0)
//        }
//        // ÏúÑÏùò Í≤ΩÏö∞Í∞Ä ÏïÑÎãå Í≤ΩÏö∞
//        else {
//            return false
//        }
//    }
//    
//    func loadNextQuestion() {
//        
//    }
//
//}
